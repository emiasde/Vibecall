<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCall - Lista de Salas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .speaking-active {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            animation: pulse-audio 1.5s infinite;
        }
        @keyframes pulse-audio {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        input[type=range] { height: 6px; -webkit-appearance: none; margin: 10px 0; width: 100%; background: #334155; border-radius: 3px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6366f1; cursor: pointer; transition: background .15s ease-in-out; border: 2px solid #1e293b; }
        input[type=range]::-webkit-slider-thumb:hover { background: #818cf8; }

        .meter-container { width: 100%; height: 12px; background-color: #1e293b; border-radius: 6px; overflow: hidden; position: relative; margin-top: 8px; }
        .meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e 0%, #eab308 80%, #ef4444 100%); transition: width 0.05s linear; }
        .threshold-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: white; z-index: 10; box-shadow: 0 0 4px rgba(0,0,0,0.5); }

        #settings-drawer { transition: transform 0.3s ease-in-out; }
        #drawer-overlay { transition: opacity 0.3s ease-in-out; }
        
        /* Video Styles */
        video { object-fit: cover; width: 100%; height: 100%; transform: scaleX(-1); }
        video.screen-share { object-fit: contain; transform: scaleX(1); background: #000; }

        /* Theater Mode Fallback (CSS Fullscreen) */
        .theater-mode {
            position: fixed !important;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            background: #000;
            border-radius: 0 !important;
            border: none !important;
        }
        .theater-mode video {
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen overflow-x-hidden flex flex-col">

    <!-- √Åudios Remotos (Invis√≠veis/Backstage) -->
    <div id="audio-container" class="hidden"></div>

    <!-- Ecr√£ de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-50">
        <div class="text-center w-full max-w-lg px-4" id="loading-content">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
            <p class="text-slate-400">A ligar ao servidor...</p>
        </div>
        
        <div id="auth-error-msg" class="hidden w-full max-w-lg bg-red-950/90 border border-red-500/50 p-6 rounded-xl text-left shadow-2xl mx-4 backdrop-blur-sm">
            <h3 class="text-red-400 font-bold text-lg mb-2 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i> Erro de Sistema
            </h3>
            <p id="error-desc" class="text-slate-300 text-sm mb-4">Algo correu mal.</p>
            <div class="bg-black/40 p-3 rounded-lg text-xs text-red-300 font-mono mb-4 border border-red-900/30 break-all">
                Info: <span id="error-code-display">...</span>
            </div>
            <button id="retry-btn" class="w-full bg-white text-slate-900 font-bold py-3 rounded-lg hover:bg-slate-200 transition-colors">Tentar Novamente</button>
        </div>
    </div>

    <!-- Overlay Comum -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/60 z-[60] hidden opacity-0"></div>

    <!-- Gaveta de Configura√ß√µes (Esquerda) -->
    <div id="settings-drawer" class="fixed top-0 left-0 h-full w-80 bg-slate-900 border-r border-slate-800 z-[70] transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-indigo-400"></i> √Åudio
            </h2>
            <button id="close-drawer-btn" class="text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-5 overflow-y-auto flex-1 space-y-6">
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-slate-200 flex items-center gap-2"><i data-lucide="mic-vocal" class="w-4 h-4 text-indigo-400"></i> Noise Gate</h3>
                    <div class="flex items-center gap-2 px-2 py-1 bg-slate-900 rounded text-[10px] border border-slate-700">
                        <div id="gate-indicator" class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-200"></div>
                        <span id="gate-status-text" class="font-mono font-medium text-slate-400">OFF</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <p class="text-xs text-slate-400">Ajusta a sensibilidade do microfone.</p>
                    <div class="relative w-full">
                        <!-- Threshold padr√£o reduzido para 2 para facilitar capta√ß√£o -->
                        <input type="range" id="gate-threshold" min="0" max="100" value="2" class="w-full z-20 relative">
                        <div class="meter-container bg-slate-900 border border-slate-700">
                            <div id="audio-meter-bar" class="meter-bar opacity-80"></div>
                            <div id="threshold-marker" class="threshold-line" style="left: 2%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden w-full h-full flex-1 flex flex-col">
        
        <!-- NEW LOBBY VIEW (Room List) -->
        <div id="lobby-view" class="w-full max-w-4xl mx-auto p-4 md:p-8 flex-1 flex flex-col">
            <!-- Header do Lobby -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-slate-900/50 p-6 rounded-2xl border border-slate-800 backdrop-blur-xl relative">
                <div>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="radio" class="w-6 h-6 text-indigo-500"></i> VibeCall
                    </h1>
                    <p class="text-slate-400 text-sm mt-1">Escolhe uma sala e entra na vibe.</p>
                </div>
                
                <div class="w-full md:w-auto relative group/input">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="user" class="h-4 w-4 text-slate-500 group-focus-within/input:text-indigo-400 transition-colors"></i>
                    </div>
                    <input type="text" id="user-name-input" placeholder="O teu nome..." 
                        class="w-full md:w-64 bg-slate-950 border border-slate-700 rounded-xl px-4 py-2.5 pl-10 focus:ring-2 focus:ring-indigo-500/50 outline-none text-white text-sm placeholder-slate-600 transition-all">
                </div>
            </div>

            <!-- Lista de Salas -->
            <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden flex flex-col relative">
                <div class="p-4 border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-10 flex justify-between items-center">
                    <h2 class="font-bold text-slate-300 text-sm uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i> Salas Dispon√≠veis
                    </h2>
                    <div class="flex gap-2">
                        <button id="clean-rooms-btn" class="p-2 text-slate-500 hover:text-slate-300 hover:bg-slate-800 rounded-lg transition-colors" title="Limpar Salas Fantasma">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                        </button>
                        <button id="refresh-rooms-btn" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors" title="Atualizar Lista">
                            <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div id="rooms-list-container" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                    <div class="text-center py-10 text-slate-500 flex flex-col items-center gap-2">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>
                        <span>A procurar salas...</span>
                    </div>
                </div>

                <div class="p-4 bg-slate-900 border-t border-slate-800 flex flex-col gap-4">
                    <div class="relative group/room-name">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="tag" class="h-4 w-4 text-slate-500 group-focus-within/room-name:text-indigo-400 transition-colors"></i>
                        </div>
                        <input type="text" id="new-room-name" placeholder="Nome da sala (Opcional)" 
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 pl-10 focus:ring-2 focus:ring-indigo-500/50 outline-none text-white text-sm placeholder-slate-600 transition-all">
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="create-room-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-900/20">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            Criar
                        </button>
                        
                        <div class="flex-1 flex gap-2">
                            <input type="text" id="room-id-input" placeholder="C√≥digo..." class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 outline-none text-white text-sm focus:border-indigo-500 font-mono uppercase">
                            <button id="join-room-btn" class="bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-xl border border-slate-700 transition-colors">
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room View (In-Call) -->
        <div id="room-view" class="max-w-6xl mx-auto space-y-6 hidden w-full p-4 md:p-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between bg-slate-900 p-4 rounded-xl border border-slate-800 gap-4 shadow-lg mb-6 relative">
                <button id="open-settings-btn" class="absolute top-4 left-4 md:static p-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg transition-colors border border-slate-700 shadow-lg z-10">
                    <i data-lucide="settings-2" class="w-5 h-5"></i>
                </button>

                <div class="flex items-center gap-4 mt-8 md:mt-0 ml-2 md:ml-0">
                    <div class="bg-indigo-600 p-2.5 rounded-lg hidden md:block">
                        <i data-lucide="radio" class="w-5 h-5 text-white animate-pulse"></i>
                    </div>
                    <div>
                        <h2 class="font-bold flex items-center gap-2 text-lg text-white">
                            <span id="display-room-name">Sala</span>
                            <span id="display-room-id" class="font-mono text-sm bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">ID</span>
                            <button id="copy-link-btn" class="p-1.5 hover:bg-slate-800 rounded-md text-slate-400 hover:text-white transition-colors" title="Copiar ID">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                        </h2>
                        <p class="text-xs text-slate-400 mt-1"><span id="participant-count">0</span> na chamada</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-wrap justify-end mt-4 md:mt-0">
                    <div id="host-controls" class="hidden flex gap-2 mr-2 md:mr-4 md:border-r border-slate-800 pr-2 md:pr-4">
                        <button id="mute-all-btn" class="flex items-center gap-2 bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/30 px-3 py-2 rounded-lg text-sm transition-all"><i data-lucide="mic-off" class="w-4 h-4"></i> Mutar Todos</button>
                        <button id="unmute-all-btn" class="flex items-center gap-2 bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-400 border border-emerald-900/30 px-3 py-2 rounded-lg text-sm transition-all"><i data-lucide="mic" class="w-4 h-4"></i> Desmutar</button>
                    </div>
                    <button id="leave-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all shadow-lg shadow-red-600/20">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Sair
                    </button>
                </div>
            </div>

            <!-- Grelha -->
            <div id="participants-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            <div class="h-24"></div>

            <!-- Rodap√© Fixo -->
            <div class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md border border-slate-800 px-8 py-4 rounded-full flex items-center gap-4 shadow-2xl z-40">
                <!-- Bot√£o Toggle Mic -->
                <button id="toggle-mic-btn" class="p-4 rounded-full transition-all bg-slate-700 hover:bg-slate-600 text-white relative group shadow-lg shadow-indigo-900/20" title="Microfone">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                
                <!-- Bot√£o Toggle Video -->
                <button id="toggle-video-btn" class="p-4 rounded-full transition-all bg-slate-700 hover:bg-slate-600 text-white relative group shadow-lg shadow-indigo-900/20" title="C√¢mara">
                    <i data-lucide="video-off" class="w-6 h-6"></i>
                </button>

                <!-- Bot√£o Partilha Ecr√£ -->
                <button id="share-screen-btn" class="p-4 rounded-full transition-all bg-slate-700 hover:bg-slate-600 text-white relative group shadow-lg shadow-indigo-900/20" title="Partilhar Ecr√£">
                    <i data-lucide="monitor-up" class="w-6 h-6"></i>
                </button>

                <div class="h-8 w-[1px] bg-slate-700"></div>
                <!-- Bot√£o Sair -->
                <button id="footer-leave-btn" class="p-4 bg-red-600 rounded-full hover:bg-red-700 transition-all text-white shadow-lg shadow-red-600/30">
                    <i data-lucide="phone-off" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-xl border border-slate-700 opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, deleteDoc, addDoc, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnZGlheXlDQZ3Iwks8A5SNR9dfi3tbOuo",
            authDomain: "vibecall-78012.firebaseapp.com",
            projectId: "vibecall-78012",
            storageBucket: "vibecall-78012.firebasestorage.app",
            messagingSenderId: "530627865250",
            appId: "1:530627865250:web:f852a863abfe85549305fb",
            measurementId: "G-NH2DKE8TH5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'vibecall-site-live';

        const rtcConfig = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }], iceCandidatePoolSize: 10 };

        // Globals
        let currentUser = null;
        let currentRoomID = null;
        let currentUserName = '';
        let isHost = false;
        let prevParticipantsCount = 0;
        let currentAudioOutputId = 'default';
        let isScreenSharing = false;
        
        let localStream = null;
        let processedStream = null;
        let peerConnections = {}; 
        let audioContext = null;
        let audioAnalysers = {}; 
        let gateGainNode = null; 
        let animationFrameId = null;
        let speechHoldTimer = null;
        let remoteStreams = {}; 

        let unsubRoom = null;
        let unsubParticipants = null;
        let unsubOffers = null;
        let unsubAnswers = null;
        let unsubCandidates = null;
        let unsubLobby = null; 
        
        let participantsData = [];
        let globalMuteState = false;

        const els = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingContent: document.getElementById('loading-content'),
            authErrorMsg: document.getElementById('auth-error-msg'),
            errorCodeDisplay: document.getElementById('error-code-display'),
            retryBtn: document.getElementById('retry-btn'),
            appContainer: document.getElementById('app-container'),
            lobbyView: document.getElementById('lobby-view'),
            roomView: document.getElementById('room-view'),
            roomsListContainer: document.getElementById('rooms-list-container'),
            userNameInput: document.getElementById('user-name-input'),
            roomIdInput: document.getElementById('room-id-input'),
            newRoomNameInput: document.getElementById('new-room-name'),
            createRoomBtn: document.getElementById('create-room-btn'),
            joinRoomBtn: document.getElementById('join-room-btn'),
            displayRoomId: document.getElementById('display-room-id'),
            displayRoomName: document.getElementById('display-room-name'),
            participantCount: document.getElementById('participant-count'),
            participantsGrid: document.getElementById('participants-grid'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            hostControls: document.getElementById('host-controls'),
            muteAllBtn: document.getElementById('mute-all-btn'),
            unmuteAllBtn: document.getElementById('unmute-all-btn'),
            leaveBtn: document.getElementById('leave-btn'),
            footerLeaveBtn: document.getElementById('footer-leave-btn'),
            toggleMicBtn: document.getElementById('toggle-mic-btn'),
            toggleVideoBtn: document.getElementById('toggle-video-btn'),
            shareScreenBtn: document.getElementById('share-screen-btn'),
            toast: document.getElementById('toast'),
            audioContainer: document.getElementById('audio-container'),
            
            // Drawers
            settingsDrawer: document.getElementById('settings-drawer'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            openSettingsBtn: document.getElementById('open-settings-btn'),
            closeDrawerBtn: document.getElementById('close-drawer-btn'),

            // Noise Gate
            gateThreshold: document.getElementById('gate-threshold'),
            audioMeterBar: document.getElementById('audio-meter-bar'),
            thresholdMarker: document.getElementById('threshold-marker'),
            gateIndicator: document.getElementById('gate-indicator'),
            gateStatusText: document.getElementById('gate-status-text')
        };

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.remove('opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 3000);
        }

        // --- GLOBAL HELPER: Request Fullscreen with Fallback ---
        window.toggleVideoFullscreen = (id, cardId) => {
            const video = document.getElementById(id);
            const card = document.getElementById(cardId);
            if (!video || !card) return;
            const enterFullscreen = video.requestFullscreen || video.webkitRequestFullscreen || video.msRequestFullscreen || video.webkitEnterFullscreen;
            if (enterFullscreen) {
                enterFullscreen.call(video).catch(err => {
                    console.warn("Fullscreen nativo bloqueado, usando modo teatro.", err);
                    card.classList.toggle('theater-mode');
                });
            } else {
                card.classList.toggle('theater-mode');
            }
        };

        // --- ADMIN FUNCTIONS ---
        window.adminDeleteRoom = async (roomId) => {
            const password = prompt("Digite a senha de administrador para fechar esta sala:");
            if (password === "joao2908") {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId));
                    showToast("Sala fechada com sucesso!");
                } catch (e) {
                    console.error(e);
                    showToast("Erro ao fechar sala.");
                }
            } else if (password !== null) {
                alert("Senha incorreta!");
            }
        };

        // --- GHOST ROOM CLEANUP (Regular) ---
        async function cleanGhostRooms() {
            if (!confirm("Limpar salas vazias e corrigir erros?")) return;
            showToast("A limpar salas...");
            try {
                const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms');
                const snap = await getDocs(roomsRef);
                let deleted = 0, corrected = 0;
                const checks = [];
                snap.forEach(roomDoc => {
                    checks.push((async () => {
                        const roomId = roomDoc.id;
                        const partsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'participants');
                        const partsSnap = await getDocs(partsRef);
                        if (partsSnap.empty) { await deleteDoc(roomDoc.ref); deleted++; } 
                        else {
                            const realCount = partsSnap.size;
                            if (roomDoc.data().participantCount !== realCount) { await updateDoc(roomDoc.ref, { participantCount: realCount }); corrected++; }
                        }
                    })());
                });
                await Promise.all(checks);
                showToast(`Limpeza: ${deleted} apagadas, ${corrected} corrigidas.`);
            } catch (e) { console.error(e); showToast("Erro na limpeza."); }
        }

        // --- ROOM LIST LISTENER ---
        function startLobbyListener() {
            const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms');
            unsubLobby = onSnapshot(roomsRef, (snap) => {
                els.roomsListContainer.innerHTML = '';
                if (snap.empty) {
                    els.roomsListContainer.innerHTML = `<div class="text-center py-10 text-slate-500 flex flex-col items-center gap-2"><i data-lucide="ghost" class="w-8 h-8 opacity-50"></i><span class="text-sm">Nenhuma sala ativa.</span></div>`;
                } else {
                    snap.forEach(docSnapshot => {
                        const roomData = docSnapshot.data();
                        const roomId = docSnapshot.id;
                        const roomName = roomData.roomName || roomId;
                        const now = Date.now();
                        const count = roomData.participantCount || 0;
                        const created = roomData.createdAt || 0;
                        if (count <= 0 && (now - created) > 120000) { deleteDoc(docSnapshot.ref).catch(()=>{}); return; }
                        const minutesAgo = Math.floor((now - created) / 60000);
                        const timeText = minutesAgo < 1 ? 'Agora mesmo' : `H√° ${minutesAgo} min`;
                        const card = document.createElement('div');
                        card.className = "bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-indigo-500/50 rounded-xl p-4 flex justify-between items-center transition-all group cursor-pointer";
                        card.onclick = () => { els.roomIdInput.value = roomId; joinRoomFromInput(); };
                        const badgeHTML = roomData.roomName ? `<span class="font-mono bg-slate-900 text-slate-500 px-1.5 py-0.5 rounded border border-slate-700 text-[10px]">#${roomId}</span>` : '';
                        
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="bg-slate-700 p-2.5 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors text-slate-400">
                                    <i data-lucide="hash" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-white tracking-wide text-sm">${roomName}</h3>
                                        ${badgeHTML}
                                    </div>
                                    <div class="flex items-center gap-3 text-xs text-slate-400 mt-0.5">
                                        <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${timeText}</span>
                                        ${count > 0 ? `<span class="flex items-center gap-1 text-emerald-400"><i data-lucide="users" class="w-3 h-3"></i> ${count} online</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); window.adminDeleteRoom('${roomId}')" class="p-2 text-slate-500 hover:text-red-400 hover:bg-slate-700 rounded-lg transition-colors" title="Admin: Fechar Sala">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                </button>
                                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all opacity-0 group-hover:opacity-100 translate-x-2 group-hover:translate-x-0">Entrar</button>
                            </div>
                        `;
                        els.roomsListContainer.appendChild(card);
                    });
                }
                lucide.createIcons();
            });
        }

        // --- SISTEMA DE SOM ---
        function playSound(type) {
            if (!audioContext || audioContext.state === 'suspended') return;
            const osc = audioContext.createOscillator(); const gainNode = audioContext.createGain(); osc.connect(gainNode); gainNode.connect(audioContext.destination); const now = audioContext.currentTime;
            if (type === 'join') { osc.type='sine'; osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(1200,now+0.1); gainNode.gain.setValueAtTime(0.1,now); gainNode.gain.exponentialRampToValueAtTime(0.01,now+0.5); osc.start(now); osc.stop(now+0.5); }
            else if (type === 'leave') { osc.type='sine'; osc.frequency.setValueAtTime(300,now); osc.frequency.linearRampToValueAtTime(100,now+0.3); gainNode.gain.setValueAtTime(0.1,now); gainNode.gain.linearRampToValueAtTime(0.01,now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'muteAll') { osc.type='square'; osc.frequency.setValueAtTime(600,now); gainNode.gain.setValueAtTime(0.05,now); gainNode.gain.setValueAtTime(0,now+0.1); gainNode.gain.setValueAtTime(0.05,now+0.15); gainNode.gain.setValueAtTime(0,now+0.25); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'unmuteAll') { osc.type='sine'; osc.frequency.setValueAtTime(300,now); osc.frequency.exponentialRampToValueAtTime(600,now+0.2); gainNode.gain.setValueAtTime(0.05,now); gainNode.gain.linearRampToValueAtTime(0,now+0.2); osc.start(now); osc.stop(now+0.2); }
        }

        async function unlockAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') { await audioContext.resume(); const b=audioContext.createBuffer(1,1,22050); const s=audioContext.createBufferSource(); s.buffer=b; s.connect(audioContext.destination); s.start(0); }
        }

        async function initAuth() {
            try { els.loadingContent.classList.remove('hidden'); els.authErrorMsg.classList.add('hidden'); await signInAnonymously(auth); } 
            catch (err) { els.loadingContent.classList.add('hidden'); els.authErrorMsg.classList.remove('hidden'); els.errorCodeDisplay.textContent = err.code||err.message; }
        }
        onAuthStateChanged(auth, u => {
            if (u) { 
                currentUser = u; 
                els.loadingScreen.classList.add('hidden'); 
                els.appContainer.classList.remove('hidden'); 
                els.lobbyView.classList.remove('hidden'); 
                startLobbyListener(); 
            }
        });

        // --- AUDIO/VIDEO PIPELINE ---
        async function initLocalStream(withVideo = false) {
            try {
                await unlockAudio();
                if (localStream) localStream.getTracks().forEach(t => t.stop());

                // Removida supress√£o agressiva para mobile
                const constraints = {
                    audio: { echoCancellation: true, noiseSuppression: false, autoGainControl: true },
                    video: withVideo ? { facingMode: "user" } : false
                };

                const raw = await navigator.mediaDevices.getUserMedia(constraints);
                localStream = raw;
                
                const source = audioContext.createMediaStreamSource(raw);
                gateGainNode = audioContext.createGain(); gateGainNode.gain.value = 0;
                const dest = audioContext.createMediaStreamDestination();
                source.connect(gateGainNode); gateGainNode.connect(dest);
                
                processedStream = dest.stream;
                if (withVideo) {
                    const videoTrack = raw.getVideoTracks()[0];
                    if (videoTrack) processedStream.addTrack(videoTrack);
                }

                const an = audioContext.createAnalyser(); an.fftSize=512; source.connect(an); audioAnalysers['local']=an;
                
                // For√ßar speaker sempre que poss√≠vel
                if ('setSinkId' in HTMLMediaElement.prototype) await updateAudioOutput();

                return true;
            } catch (err) { 
                console.error("Erro Media:", err);
                let errorMsg = "Erro ao acessar dispositivos.";
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMsg = "üîí Permiss√£o de Microfone Bloqueada! Ative nas configura√ß√µes do navegador.";
                }
                alert(errorMsg); 
                return false; 
            }
        }

        function setupRemoteAudioAnalysis(id, stream) {
            remoteStreams[id] = stream;
            const s = audioContext.createMediaStreamSource(stream);
            const a = audioContext.createAnalyser(); a.fftSize=32; s.connect(a); audioAnalysers[id]=a;
        }

        function startProcessingLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            const loop = () => {
                if (audioAnalysers['local'] && gateGainNode) {
                    const an = audioAnalysers['local']; const data = new Uint8Array(an.frequencyBinCount); an.getByteFrequencyData(data);
                    let sum = 0; for(let i=0; i<data.length; i++) sum+=data[i];
                    const volPercent = Math.min(100, Math.round((sum/data.length/64)*100));
                    els.audioMeterBar.style.width = `${volPercent}%`;
                    const thresh = parseInt(els.gateThreshold.value);
                    const myData = participantsData.find(p => p.id === currentUser.uid);
                    const isMuted = myData?.isMuted || false;
                    if (!isMuted && volPercent > thresh) {
                        gateGainNode.gain.setTargetAtTime(1, audioContext.currentTime, 0.05);
                        els.gateIndicator.classList.replace('bg-red-500','bg-emerald-500'); els.gateStatusText.textContent = "A Transmitir"; els.gateStatusText.className="font-mono font-medium text-emerald-400";
                        if (speechHoldTimer) clearTimeout(speechHoldTimer); speechHoldTimer = setTimeout(() => { speechHoldTimer = null; }, 150);
                    } else if (!speechHoldTimer) {
                        gateGainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.05);
                        els.gateIndicator.classList.replace('bg-emerald-500','bg-red-500'); els.gateStatusText.textContent = isMuted ? "Mutado" : "Sil√™ncio"; els.gateStatusText.className = isMuted ? "font-mono font-medium text-red-400" : "font-mono font-medium text-slate-400";
                    }
                }
                Object.keys(audioAnalysers).forEach(id => {
                    const an = audioAnalysers[id]; const d = new Uint8Array(an.frequencyBinCount); an.getByteFrequencyData(d);
                    let s=0; for(let i=0;i<d.length;i++) s+=d[i];
                    const el = document.getElementById(`visual-${id}`);
                    if (el) { (s/d.length > 10) ? el.classList.add('speaking-active') : el.classList.remove('speaking-active'); }
                });
                animationFrameId = requestAnimationFrame(loop);
            };
            loop();
        }

        els.gateThreshold.addEventListener('input', (e) => els.thresholdMarker.style.left = `${e.target.value}%`);

        async function updateAudioOutput() {
            if (!('setSinkId' in HTMLMediaElement.prototype)) return;
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioOutputs = devices.filter(d => d.kind === 'audiooutput');
                let targetId = 'default';
                
                // Procurar sempre por 'speaker' para for√ßar altifalante
                const speaker = audioOutputs.find(d => d.label.toLowerCase().includes('speaker'));
                if (speaker) targetId = speaker.deviceId;
                
                currentAudioOutputId = targetId;
                const audioElements = els.audioContainer.querySelectorAll('audio');
                for (const audio of audioElements) {
                    if (audio.sinkId !== targetId) await audio.setSinkId(targetId).catch(e => console.warn("Failed to set sinkId", e));
                }
            } catch(e) { console.error("Error updating audio output:", e); }
        }

        // --- SCREEN SHARING ---
        async function toggleScreenShare() {
            if (!currentUser || !currentRoomID) return;
            if (isScreenSharing) {
                isScreenSharing = false;
                await toggleMyCamera(); 
                updateFooterScreenShareState(false);
            } else {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    screenTrack.onended = () => { if (isScreenSharing) toggleScreenShare(); };
                    isScreenSharing = true;
                    updateFooterScreenShareState(true);
                    Object.keys(peerConnections).forEach(pid => {
                        const pc = peerConnections[pid];
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(screenTrack);
                        else {
                            pc.addTrack(screenTrack, processedStream);
                            pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', pid, 'offers'), { 
                                    offer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp }, from: currentUser.uid 
                                });
                            });
                        }
                    });
                    localStream = screenStream; 
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', currentUser.uid), { isVideoOn: true, isScreenSharing: true });
                } catch (err) { console.error("Erro partilha:", err); showToast("Cancelado ou n√£o suportado."); }
            }
        }

        function updateFooterScreenShareState(isOn) {
            els.shareScreenBtn.className = `p-4 rounded-full transition-all text-white relative group shadow-lg ${isOn ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-slate-700 hover:bg-slate-600'}`;
        }

        // --- VIDEO TOGGLE ---
        async function toggleMyCamera() {
            if (!currentUser || !currentRoomID) return;
            const myData = participantsData.find(p => p.id === currentUser.uid);
            
            if (isScreenSharing) {
                isScreenSharing = false;
                updateFooterScreenShareState(false);
            }

            const newVideoState = !myData.isVideoOn;

            if (newVideoState) {
                await initLocalStream(true);
                const videoTrack = processedStream.getVideoTracks()[0];
                if (videoTrack) {
                    Object.keys(peerConnections).forEach(pid => {
                        const pc = peerConnections[pid];
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                        else {
                            pc.addTrack(videoTrack, processedStream);
                            pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', pid, 'offers'), { 
                                    offer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp }, from: currentUser.uid 
                                });
                            });
                        }
                    });
                }
            } else {
                if (localStream) localStream.getVideoTracks().forEach(t => t.stop());
            }

            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', currentUser.uid), { isVideoOn: newVideoState, isScreenSharing: false });
            updateFooterVideoState(newVideoState);
        }

        function updateFooterVideoState(isOn) {
            els.toggleVideoBtn.className = `p-4 rounded-full transition-all text-white relative group shadow-lg ${isOn ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-slate-700 hover:bg-slate-600'}`;
            els.toggleVideoBtn.innerHTML = `<i data-lucide="${isOn ? 'video' : 'video-off'}" class="w-6 h-6"></i>`;
            lucide.createIcons();
        }

        // --- ROOM LOGIC ---
        async function createRoom() {
            const name = els.userNameInput.value.trim();
            const roomName = els.newRoomNameInput.value.trim();
            if (!name) return showToast("Nome obrigat√≥rio");
            if (!await initLocalStream(false)) return; 
            currentUserName = name;
            els.createRoomBtn.disabled = true; els.createRoomBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> A criar...`;
            try {
                const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', newId), { 
                    hostId: currentUser.uid, createdAt: Date.now(), allMuted: false, participantCount: 0, roomName: roomName || null
                });
                await joinRoomLogic(newId);
            } catch (e) { alert("Erro: "+e.message); els.createRoomBtn.disabled = false; els.createRoomBtn.textContent = "Criar"; }
        }

        async function joinRoomFromInput() {
            const id = els.roomIdInput.value.trim().toUpperCase();
            const name = els.userNameInput.value.trim();
            if (!name) return showToast("Digita o teu nome primeiro!");
            if (!id) return showToast("Seleciona uma sala ou digita o c√≥digo.");
            if (!await initLocalStream(false)) return; 
            currentUserName = name;
            els.joinRoomBtn.disabled = true;
            await joinRoomLogic(id);
        }

        async function joinRoomLogic(id) {
            currentRoomID = id; prevParticipantsCount = 0;
            if (unsubLobby) unsubLobby(); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', id), { participantCount: increment(1) }).catch(()=>{});
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', id, 'participants', currentUser.uid), {
                name: currentUserName, joinedAt: Date.now(), isMuted: false, isVideoOn: false, isScreenSharing: false, volume: 1.0
            });
            els.lobbyView.classList.add('hidden'); els.roomView.classList.remove('hidden'); els.displayRoomId.textContent = id;
            startProcessingLoop(); setupAllListeners(id);
        }

        function setupAllListeners(roomId) {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
            const partsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'participants');
            unsubRoom = onSnapshot(roomRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.roomName) els.displayRoomName.textContent = data.roomName; else els.displayRoomName.textContent = "Sala";
                    if (data.allMuted && !globalMuteState) playSound('muteAll');
                    else if (!data.allMuted && globalMuteState) playSound('unmuteAll');
                    globalMuteState = data.allMuted || false;
                    isHost = (data.hostId === currentUser.uid);
                    isHost ? els.hostControls.classList.remove('hidden') : els.hostControls.classList.add('hidden');
                } else { alert("A sala foi encerrada."); leaveCall(true); }
            });
            unsubParticipants = onSnapshot(query(partsRef), (snap) => {
                const count = snap.size;
                if (count > prevParticipantsCount && prevParticipantsCount !== 0) playSound('join');
                if (count < prevParticipantsCount) playSound('leave');
                prevParticipantsCount = count;
                participantsData = [];
                snap.forEach(d => {
                    const data = d.data(); participantsData.push({ id: d.id, ...data });
                    const audioEl = document.getElementById(`audio-${d.id}`); if (audioEl) audioEl.volume = (data.volume!==undefined)?data.volume:1.0;
                    if (d.id !== currentUser.uid && !peerConnections[d.id]) {
                        (currentUser.uid < d.id) ? createPeerConnection(d.id, true) : createPeerConnection(d.id, false);
                    }
                });
                renderParticipants();
            });
            unsubOffers = onSnapshot(collection(partsRef, currentUser.uid, 'offers'), s => s.docChanges().forEach(c => { if(c.type==='added') handleOffer(c.doc.data().offer, c.doc.data().from) }));
            unsubAnswers = onSnapshot(collection(partsRef, currentUser.uid, 'answers'), s => s.docChanges().forEach(c => { if(c.type==='added') handleAnswer(c.doc.data().answer, c.doc.data().from) }));
            unsubCandidates = onSnapshot(collection(partsRef, currentUser.uid, 'candidates'), s => s.docChanges().forEach(c => { if(c.type==='added') handleCandidate(c.doc.data().candidate, c.doc.data().from) }));
        }

        // --- WEBRTC ---
        function createPeerConnection(tid, init) {
            if (peerConnections[tid]) return;
            const pc = new RTCPeerConnection(rtcConfig); peerConnections[tid] = pc;
            processedStream.getTracks().forEach(t => pc.addTrack(t, processedStream));
            pc.onicecandidate = e => { if (e.candidate) addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', tid, 'candidates'), { candidate: e.candidate.toJSON(), from: currentUser.uid }); };
            pc.ontrack = e => {
                let el = document.getElementById(`audio-${tid}`);
                if (!el) { 
                    el=document.createElement('audio'); el.id=`audio-${tid}`; el.autoplay=true; el.setAttribute('playsinline',''); els.audioContainer.appendChild(el);
                    if ('setSinkId' in HTMLMediaElement.prototype && currentAudioOutputId !== 'default') el.setSinkId(currentAudioOutputId).catch(e=>{});
                }
                if (e.track.kind === 'audio') { el.srcObject = e.streams[0]; setupRemoteAudioAnalysis(tid, e.streams[0]); }
                if (e.track.kind === 'video') { remoteStreams[tid] = e.streams[0]; renderParticipants(); }
            };
            if (init) pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', tid, 'offers'), { offer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp }, from: currentUser.uid }));
        }
        async function handleOffer(o, f) { if (!peerConnections[f]) createPeerConnection(f, false); await peerConnections[f].setRemoteDescription(new RTCSessionDescription(o)); const a=await peerConnections[f].createAnswer(); await peerConnections[f].setLocalDescription(a); addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', f, 'answers'), { answer: { type: a.type, sdp: a.sdp }, from: currentUser.uid }); }
        async function handleAnswer(a, f) { 
            const pc = peerConnections[f];
            if (pc && pc.signalingState === "have-local-offer") {
                 await pc.setRemoteDescription(new RTCSessionDescription(a));
            }
        }
        async function handleCandidate(c, f) { if (peerConnections[f]) await peerConnections[f].addIceCandidate(new RTCIceCandidate(c)); }

        // --- RENDER UI ---
        function renderParticipants() {
            els.participantsGrid.innerHTML = '';
            els.participantCount.textContent = participantsData.length;
            participantsData.sort((a, b) => a.joinedAt - b.joinedAt);
            const myData = participantsData.find(p => p.id === currentUser.uid);
            updateFooterMicState(myData?.isMuted);
            updateFooterVideoState(myData?.isVideoOn);
            updateFooterScreenShareState(myData?.isScreenSharing);

            participantsData.forEach(p => {
                const isMe = p.id === currentUser.uid;
                const isFirst = p.id === participantsData[0]?.id;
                const visualId = isMe ? 'local' : p.id;
                const card = document.createElement('div');
                const micIcon = p.isMuted ? '<i data-lucide="mic-off" class="w-3.5 h-3.5"></i>' : '<i data-lucide="mic" class="w-3.5 h-3.5"></i>';
                const micClass = p.isMuted ? 'bg-red-500/20 text-red-500' : 'bg-emerald-500/20 text-emerald-500';
                
                let volCtrl = '';
                if (isHost && !isMe) {
                    const vol = (p.volume!==undefined) ? p.volume : 1.0;
                    volCtrl = `<div class="w-full px-4 mt-2 relative z-20"><label class="text-[10px] text-slate-400 font-bold">Vol: ${Math.round(vol*100)}%</label><input type="range" min="0" max="1" step="0.1" value="${vol}" onchange="window.updateUserVolume('${p.id}', this.value)"></div>`;
                }

                const cardId = `participant-card-${p.id}`;
                card.id = cardId;
                card.className = `relative aspect-video rounded-2xl flex flex-col items-center justify-center border-2 transition-all shadow-lg overflow-hidden ${p.isMuted ? 'bg-slate-900 border-slate-800' : 'bg-slate-800 border-indigo-500/30'}`;
                
                let contentHTML = '';
                
                if (p.isVideoOn) {
                    const videoClass = p.isScreenSharing ? 'screen-share' : '';
                    const maximizeBtn = `<button data-video-target="video-${p.id}" data-card-target="${cardId}" class="maximize-btn absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-lg backdrop-blur-sm transition-all z-20" title="Tela Cheia"><i data-lucide="maximize" class="w-4 h-4"></i></button>`;
                    contentHTML = `<video id="video-${p.id}" autoplay playsinline muted class="absolute inset-0 w-full h-full ${videoClass}"></video>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                    ${maximizeBtn}
                    <div class="absolute bottom-3 left-4 right-14 text-white font-bold truncate z-10 text-sm flex items-center gap-2">
                        ${p.name} ${isMe?'(Tu)':''} ${p.isScreenSharing?'<span class="text-[10px] bg-indigo-600 px-1 rounded ml-1">Ecr√£</span>':''}
                    </div>`;
                } else {
                    contentHTML = `${globalMuteState ? '<div class="absolute top-2 left-2 px-2 py-0.5 bg-red-600/80 text-[10px] font-bold rounded text-white z-10">Silenciado</div>' : ''}
                    <div id="visual-${visualId}" class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-2xl font-bold text-indigo-400 mb-1 transition-all duration-75">${(p.name||'?').charAt(0).toUpperCase()}</div>
                    <div class="text-center z-10 w-full"><div class="font-medium flex items-center justify-center gap-1 text-slate-200">${p.name} ${isMe ? '<span class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded uppercase font-bold text-slate-300">Tu</span>' : ''} ${isFirst ? '<i data-lucide="crown" class="w-3 h-3 text-yellow-500 ml-1"></i>' : ''}</div>${volCtrl}</div>`;
                }

                card.innerHTML = contentHTML + `<div class="absolute bottom-3 right-3 p-1.5 rounded-full ${micClass} z-20 shadow-md backdrop-blur-sm">${micIcon}</div>`;
                els.participantsGrid.appendChild(card);

                if (p.isVideoOn) {
                    const videoEl = document.getElementById(`video-${p.id}`);
                    if (videoEl) {
                        if (isMe && localStream) videoEl.srcObject = localStream;
                        else if (!isMe && remoteStreams[p.id]) videoEl.srcObject = remoteStreams[p.id];
                    }
                }
            });
            lucide.createIcons();
        }

        function updateFooterMicState(isMuted) {
            els.toggleMicBtn.className = `p-4 rounded-full transition-all text-white ${isMuted ? 'bg-red-600 hover:bg-red-500' : 'bg-slate-700 hover:bg-slate-600'}`;
            els.toggleMicBtn.innerHTML = `<i data-lucide="${isMuted ? 'mic-off' : 'mic'}" class="w-6 h-6"></i>`;
            lucide.createIcons();
        }

        window.updateUserVolume = async (uid, val) => {
            if (!currentRoomID) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', uid), { volume: parseFloat(val) });
        };

        async function toggleMyMic() {
            if (!currentUser || !currentRoomID) return;
            const myData = participantsData.find(p => p.id === currentUser.uid);
            if (myData) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', currentUser.uid), { isMuted: !myData.isMuted });
        }

        async function setAllMute(state) {
            if (!currentUser || !currentRoomID || !isHost) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID), { allMuted: state });
            const updates = participantsData.map(p => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', p.id), { isMuted: state }));
            await Promise.all(updates);
            showToast(state ? "Todos silenciados" : "Microfones liberados");
        }

        async function leaveCall(force = false) {
            if (force || confirm("Sair da sala?")) {
                Object.values(peerConnections).forEach(pc => pc.close()); peerConnections = {};
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                try { 
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID), { participantCount: increment(-1) });
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID, 'participants', currentUser.uid)); 
                    if (participantsData.length <= 1) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomID));
                } catch(e){}
                window.location.reload();
            }
        }

        // Bindings
        els.createRoomBtn.addEventListener('click', createRoom);
        els.joinRoomBtn.addEventListener('click', joinRoomFromInput);
        els.retryBtn.addEventListener('click', initAuth);
        els.toggleMicBtn.addEventListener('click', toggleMyMic);
        els.toggleVideoBtn.addEventListener('click', toggleMyCamera);
        els.shareScreenBtn.addEventListener('click', toggleScreenShare);
        els.muteAllBtn.addEventListener('click', () => setAllMute(true));
        els.unmuteAllBtn.addEventListener('click', () => setAllMute(false));
        els.leaveBtn.addEventListener('click', () => leaveCall(false));
        els.footerLeaveBtn.addEventListener('click', () => leaveCall(false));
        els.copyLinkBtn.addEventListener('click', () => {
            if (currentRoomID) {
                const el = document.createElement('textarea'); el.value = currentRoomID; document.body.appendChild(el); el.select();
                try { document.execCommand('copy'); showToast("Copiado!"); } catch (err) { showToast("Erro copiar"); }
                document.body.removeChild(el);
            }
        });
        document.getElementById('clean-rooms-btn').addEventListener('click', cleanGhostRooms);
        
        // Event delegation for Maximize buttons to avoid inline event policy errors
        els.participantsGrid.addEventListener('click', (e) => {
            const btn = e.target.closest('.maximize-btn');
            if (btn) {
                const videoId = btn.dataset.videoTarget;
                const cardId = btn.dataset.cardTarget;
                window.toggleVideoFullscreen(videoId, cardId);
            }
        });
        
        // Drawer & Refresh
        const toggleDrawer = (o) => { o ? (els.drawerOverlay.classList.remove('hidden'), setTimeout(()=>els.drawerOverlay.classList.remove('opacity-0'),10), els.settingsDrawer.classList.remove('-translate-x-full')) : (els.settingsDrawer.classList.add('-translate-x-full'), els.drawerOverlay.classList.add('opacity-0'), setTimeout(()=>els.drawerOverlay.classList.add('hidden'),300)); };
        
        els.openSettingsBtn.addEventListener('click', () => toggleDrawer(true));
        els.closeDrawerBtn.addEventListener('click', () => toggleDrawer(false));
        els.drawerOverlay.addEventListener('click', () => { toggleDrawer(false); });
        
        document.getElementById('refresh-rooms-btn').addEventListener('click', startLobbyListener);

        lucide.createIcons(); initAuth();
    </script>
</body> 
</html>
